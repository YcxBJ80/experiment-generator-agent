# Architecture & Project Layout

## High-level system

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   React Client   │◄──►│  Express Server │◄──►│ Perplexity MCP  │
│   (Vite + TS)    │    │  (Node + TS)    │    │  Client Bridge  │
└─────────────────┘    └──────────────────┘    └─────────────────┘
            │                         │
            ▼                         ▼
     ┌─────────────┐         ┌────────────────┐
     │ Supabase DB │         │ OpenRouter GPT │
     │  (Postgres) │         │  + Streaming   │
     └─────────────┘         └────────────────┘
```

- **Client (`src/`)** – Vite + React 18 frontend organised into `pages/`, `components/`, `hooks/`, `lib/`, and `assets/`.
- **Server (`api/` and `server/`)** – Express API, routing through `server/routes/`. Business logic sits in `server/services/`.
- **Perplexity MCP bridge (`perplexity-mcp-zerver/`)** – a Model Context Protocol stub that can be expanded to query Perplexity.
- **Database (`supabase/`)** – SQL migrations managed via the Supabase CLI.

## Repository layout at a glance

```
experiment-generator-agent/
├── api/                   # Express entrypoint and middleware
├── server/                # Route handlers, services, and supabase client helpers
├── src/                   # Vite React client code
│   ├── components/
│   ├── hooks/
│   ├── lib/
│   ├── pages/
│   └── assets/
├── docs/                  # Documentation hub (you're here)
│   ├── guides/
│   ├── operations/
│   └── wiki/
├── perplexity-mcp-zerver/ # MCP bridge server
├── public/                # Static assets served by Vite
├── supabase/              # Database migrations
└── test-*.js              # Integration harnesses
```

## Key data flows

### 1. Conversation & experiment generation

1. User messages originate from `src/pages/Home.tsx`.
2. The client streams responses from `/api/messages/generate-stream`.
3. Server routes in `server/routes/messages.ts` orchestrate:
   - Persisting messages to Supabase.
   - Requesting completions through OpenRouter.
   - Polling for experiment IDs generated by upstream services.
4. Experiments are rendered via the `/demo/:id` route (`src/pages/Demo.tsx`) inside a sandboxed iframe.

### 2. Streaming pipeline

- **Backend** – see [`docs/guides/streaming-backend.md`](./guides/streaming-backend.md) for SSE framing, chunk dispatch, and error handling details.
- **Frontend** – see [`docs/guides/streaming-frontend.md`](./guides/streaming-frontend.md) for the React state machine that renders streamed chunks.
- **Verification checklist** – see [`docs/guides/streaming-render-check.md`](./guides/streaming-render-check.md).

### 3. Authentication

- Supabase handles auth; the client uses `useAuth` and `useAuthActions` hooks for session state.
- Protected routes rely on `src/components/ProtectedRoute.tsx`.

## Operational touchpoints

- **Environment configuration:** [`docs/getting-started.md`](./getting-started.md)
- **Recent integration fixes:** [`docs/operations/api-fix-history.md`](./operations/api-fix-history.md)
- **Deployment tips:** see the “Deployment” section in `README.md` for Vercel/VPS pointers.

Keep this file updated when architectural decisions change so that engineers can reason about dependencies quickly.***
