<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•åˆ é™¤åŠŸèƒ½ä¿®å¤</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .danger-button {
            background: #dc3545;
        }
        .danger-button:hover {
            background: #c82333;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .instructions {
            background: #e7f3ff;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ åˆ é™¤åŠŸèƒ½ä¿®å¤æµ‹è¯•</h1>
    
    <div class="instructions">
        <h3>ğŸ“‹ æµ‹è¯•è¯´æ˜</h3>
        <p>è¿™ä¸ªé¡µé¢ç”¨äºæµ‹è¯•ä¿®å¤åçš„åˆ é™¤åŠŸèƒ½ã€‚è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤è¿›è¡Œæµ‹è¯•ï¼š</p>
        <ol>
            <li>é¦–å…ˆåœ¨åº”ç”¨ä¸­åˆ›å»ºä¸€äº›æµ‹è¯•å¯¹è¯</li>
            <li>ç‚¹å‡»ä¸‹é¢çš„æŒ‰é’®æ‰“å¼€åº”ç”¨é¡µé¢</li>
            <li>åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­è¿è¡Œæµ‹è¯•è„šæœ¬</li>
            <li>æµ‹è¯•åˆ é™¤åŠŸèƒ½çš„ç¡®è®¤å’Œå–æ¶ˆæ“ä½œ</li>
        </ol>
    </div>

    <div class="test-section">
        <h3>ğŸš€ å¿«é€Ÿæ“ä½œ</h3>
        <button class="test-button" onclick="openApp()">æ‰“å¼€åº”ç”¨é¡µé¢</button>
        <button class="test-button" onclick="copyTestScript()">å¤åˆ¶æµ‹è¯•è„šæœ¬</button>
        <button class="test-button" onclick="checkAPI()">æ£€æŸ¥APIçŠ¶æ€</button>
    </div>

    <div class="test-section">
        <h3>ğŸ§ª æµ‹è¯•è„šæœ¬</h3>
        <p>å°†ä»¥ä¸‹è„šæœ¬å¤åˆ¶åˆ°åº”ç”¨é¡µé¢çš„æµè§ˆå™¨æ§åˆ¶å°ä¸­è¿è¡Œï¼š</p>
        <div class="log" id="testScript">
// åˆ é™¤åŠŸèƒ½æµ‹è¯•è„šæœ¬
console.log('ğŸ§ª å¼€å§‹åˆ é™¤åŠŸèƒ½æµ‹è¯•...');

// 1. æ£€æŸ¥é¡µé¢çŠ¶æ€
function checkPageStatus() {
    console.log('ğŸ“Š é¡µé¢çŠ¶æ€æ£€æŸ¥:');
    console.log('- å½“å‰URL:', window.location.href);
    console.log('- é¡µé¢æ ‡é¢˜:', document.title);
    
    // æŸ¥æ‰¾å¯¹è¯åˆ—è¡¨
    const conversations = document.querySelectorAll('[class*="cursor-pointer"]');
    console.log('- æ‰¾åˆ°å¯¹è¯æ•°é‡:', conversations.length);
    
    // æŸ¥æ‰¾åˆ é™¤æŒ‰é’®
    const deleteButtons = document.querySelectorAll('button[title="Delete Conversation"]');
    console.log('- æ‰¾åˆ°åˆ é™¤æŒ‰é’®æ•°é‡:', deleteButtons.length);
    
    return { conversations, deleteButtons };
}

// 2. ç›‘æ§confirmå‡½æ•°
function monitorConfirm() {
    console.log('ğŸ” å¼€å§‹ç›‘æ§confirmå‡½æ•°...');
    
    const originalConfirm = window.confirm;
    let confirmCallCount = 0;
    
    window.confirm = function(message) {
        confirmCallCount++;
        console.log(`ğŸ“ confirmè¢«è°ƒç”¨ (ç¬¬${confirmCallCount}æ¬¡):`);
        console.log('- æ¶ˆæ¯:', message);
        console.log('- è°ƒç”¨æ ˆ:', new Error().stack);
        
        // è®©ç”¨æˆ·é€‰æ‹©
        const result = originalConfirm.call(this, message);
        console.log('- ç”¨æˆ·é€‰æ‹©ç»“æœ:', result, '(ç±»å‹:', typeof result, ')');
        
        return result;
    };
    
    return () => {
        window.confirm = originalConfirm;
        console.log('âœ… confirmç›‘æ§å·²æ¢å¤');
    };
}

// 3. æµ‹è¯•åˆ é™¤åŠŸèƒ½
function testDeleteFunction() {
    console.log('ğŸ—‘ï¸ å¼€å§‹æµ‹è¯•åˆ é™¤åŠŸèƒ½...');
    
    const { conversations, deleteButtons } = checkPageStatus();
    
    if (deleteButtons.length === 0) {
        console.log('âŒ æ²¡æœ‰æ‰¾åˆ°åˆ é™¤æŒ‰é’®ï¼Œè¯·ç¡®ä¿æœ‰å¯¹è¯å­˜åœ¨');
        return;
    }
    
    console.log('âœ… æ‰¾åˆ°åˆ é™¤æŒ‰é’®ï¼Œå‡†å¤‡æµ‹è¯•...');
    console.log('âš ï¸ è¯·æ³¨æ„ï¼šç‚¹å‡»åˆ é™¤æŒ‰é’®åï¼Œä¼šå¼¹å‡ºç¡®è®¤å¯¹è¯æ¡†');
    console.log('ğŸ“ å»ºè®®ï¼šå…ˆç‚¹å‡»"å–æ¶ˆ"æµ‹è¯•å–æ¶ˆåŠŸèƒ½ï¼Œå†ç‚¹å‡»"ç¡®å®š"æµ‹è¯•åˆ é™¤åŠŸèƒ½');
    
    // ç‚¹å‡»ç¬¬ä¸€ä¸ªåˆ é™¤æŒ‰é’®
    const firstDeleteButton = deleteButtons[0];
    console.log('ğŸ¯ å‡†å¤‡ç‚¹å‡»ç¬¬ä¸€ä¸ªåˆ é™¤æŒ‰é’®...');
    
    // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬
    firstDeleteButton.addEventListener('click', function(e) {
        console.log('ğŸ–±ï¸ åˆ é™¤æŒ‰é’®è¢«ç‚¹å‡»');
        console.log('- äº‹ä»¶å¯¹è±¡:', e);
        console.log('- ç›®æ ‡å…ƒç´ :', e.target);
    }, { once: true });
    
    return firstDeleteButton;
}

// 4. è¿è¡Œå®Œæ•´æµ‹è¯•
function runFullTest() {
    console.log('ğŸš€ è¿è¡Œå®Œæ•´åˆ é™¤åŠŸèƒ½æµ‹è¯•...');
    
    // å¼€å§‹ç›‘æ§
    const stopMonitoring = monitorConfirm();
    
    // æ£€æŸ¥é¡µé¢
    const deleteButton = testDeleteFunction();
    
    if (deleteButton) {
        console.log('âœ… æµ‹è¯•å‡†å¤‡å®Œæˆ');
        console.log('ğŸ‘† ç°åœ¨å¯ä»¥ç‚¹å‡»åˆ é™¤æŒ‰é’®è¿›è¡Œæµ‹è¯•');
        console.log('ğŸ“‹ æµ‹è¯•æ­¥éª¤:');
        console.log('1. ç‚¹å‡»åˆ é™¤æŒ‰é’®');
        console.log('2. åœ¨ç¡®è®¤å¯¹è¯æ¡†ä¸­ç‚¹å‡»"å–æ¶ˆ"');
        console.log('3. æ£€æŸ¥å¯¹è¯æ˜¯å¦ä»ç„¶å­˜åœ¨');
        console.log('4. å†æ¬¡ç‚¹å‡»åˆ é™¤æŒ‰é’®');
        console.log('5. åœ¨ç¡®è®¤å¯¹è¯æ¡†ä¸­ç‚¹å‡»"ç¡®å®š"');
        console.log('6. æ£€æŸ¥å¯¹è¯æ˜¯å¦è¢«åˆ é™¤');
        
        // 5ç§’ååœæ­¢ç›‘æ§
        setTimeout(() => {
            stopMonitoring();
            console.log('â° ç›‘æ§å·²è‡ªåŠ¨åœæ­¢');
        }, 30000);
    }
}

// å¯åŠ¨æµ‹è¯•
runFullTest();
        </div>
    </div>

    <div class="test-section">
        <h3>ğŸ“Š æµ‹è¯•æ—¥å¿—</h3>
        <div class="log" id="testLog">ç­‰å¾…æµ‹è¯•ç»“æœ...</div>
        <button class="test-button" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <script>
        function openApp() {
            window.open('http://localhost:5173/', '_blank');
            log('âœ… å·²æ‰“å¼€åº”ç”¨é¡µé¢');
        }

        function copyTestScript() {
            const script = document.getElementById('testScript').textContent;
            navigator.clipboard.writeText(script).then(() => {
                log('âœ… æµ‹è¯•è„šæœ¬å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                alert('æµ‹è¯•è„šæœ¬å·²å¤åˆ¶ï¼è¯·åœ¨åº”ç”¨é¡µé¢çš„æ§åˆ¶å°ä¸­ç²˜è´´å¹¶è¿è¡Œã€‚');
            }).catch(err => {
                log('âŒ å¤åˆ¶å¤±è´¥: ' + err);
            });
        }

        function checkAPI() {
            log('ğŸ” æ£€æŸ¥APIçŠ¶æ€...');
            fetch('http://localhost:3001/api/messages/conversations')
                .then(response => response.json())
                .then(data => {
                    log('âœ… APIå“åº”æ­£å¸¸');
                    log('ğŸ“Š å½“å‰å¯¹è¯æ•°é‡: ' + (data.length || 0));
                    if (data.length > 0) {
                        log('ğŸ“ ç¬¬ä¸€ä¸ªå¯¹è¯: ' + JSON.stringify(data[0], null, 2));
                    }
                })
                .catch(error => {
                    log('âŒ APIè¯·æ±‚å¤±è´¥: ' + error);
                });
        }

        function log(message) {
            const logElement = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLog() {
            document.getElementById('testLog').textContent = 'æ—¥å¿—å·²æ¸…ç©º...\n';
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        window.onload = function() {
            log('ğŸš€ åˆ é™¤åŠŸèƒ½æµ‹è¯•é¡µé¢å·²åŠ è½½');
            log('ğŸ“‹ è¯·æŒ‰ç…§è¯´æ˜è¿›è¡Œæµ‹è¯•');
        };
    </script>
</body>
</html>