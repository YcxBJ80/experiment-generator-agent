<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>简单删除测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #1a1a1a;
            color: white;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background-color: #2a2a2a;
            border-radius: 8px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 10px 15px;
            margin: 5px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .log {
            background-color: #333;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>简单删除功能测试</h1>
    
    <div class="test-section">
        <h2>测试1: 基本确认对话框</h2>
        <button onclick="testBasicConfirm()">测试confirm函数</button>
        <div id="basic-log" class="log"></div>
    </div>
    
    <div class="test-section">
        <h2>测试2: 检查应用页面</h2>
        <button onclick="openAppAndTest()">打开应用并测试删除</button>
        <div id="app-log" class="log"></div>
    </div>
    
    <div class="test-section">
        <h2>测试3: 直接API测试</h2>
        <button onclick="testDirectAPI()">测试API删除</button>
        <div id="api-log" class="log"></div>
    </div>
    
    <script>
        function log(containerId, message) {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            container.innerHTML += `[${timestamp}] ${message}<br>`;
            container.scrollTop = container.scrollHeight;
        }
        
        function testBasicConfirm() {
            log('basic-log', '🔔 测试基本confirm函数...');
            
            try {
                const result = confirm('这是一个测试确认对话框，请选择确定或取消');
                log('basic-log', `✅ confirm返回值: ${result}`);
                log('basic-log', '✅ confirm函数工作正常');
            } catch (error) {
                log('basic-log', `❌ confirm函数错误: ${error.message}`);
            }
        }
        
        function openAppAndTest() {
            log('app-log', '🌐 正在打开应用页面...');
            
            // 打开应用页面
            const appWindow = window.open('http://localhost:5173/', '_blank');
            
            if (appWindow) {
                log('app-log', '✅ 应用页面已打开');
                log('app-log', '💡 请在新窗口中手动测试删除功能');
                
                // 等待页面加载后注入测试脚本
                setTimeout(() => {
                    try {
                        // 注入测试脚本到应用页面
                        const testScript = `
                            console.log('=== 删除功能测试开始 ===');
                            
                            // 监控confirm函数
                            const originalConfirm = window.confirm;
                            window.confirm = function(message) {
                                console.log('🔔 CONFIRM被调用!');
                                console.log('📝 消息:', message);
                                const result = originalConfirm.call(this, message);
                                console.log('✅ 用户选择:', result ? '确认' : '取消');
                                return result;
                            };
                            
                            // 查找删除按钮
                            const buttons = document.querySelectorAll('button');
                            console.log('📊 页面上的按钮数量:', buttons.length);
                            
                            let deleteButtons = [];
                            buttons.forEach((btn, i) => {
                                const hasTrash = btn.innerHTML.includes('Trash') || btn.querySelector('svg');
                                if (hasTrash) {
                                    deleteButtons.push({index: i, button: btn});
                                    console.log('🗑️ 找到删除按钮:', i, btn.outerHTML.substring(0, 100));
                                }
                            });
                            
                            if (deleteButtons.length > 0) {
                                console.log('✅ 找到', deleteButtons.length, '个删除按钮');
                                console.log('💡 请手动点击删除按钮测试confirm对话框');
                            } else {
                                console.log('❌ 没有找到删除按钮');
                                console.log('💡 可能需要先创建一些对话');
                            }
                            
                            console.log('=== 测试脚本注入完成 ===');
                        `;
                        
                        appWindow.eval(testScript);
                        log('app-log', '✅ 测试脚本已注入到应用页面');
                        log('app-log', '💡 请查看应用页面的控制台输出');
                        
                    } catch (error) {
                        log('app-log', `❌ 注入脚本失败: ${error.message}`);
                        log('app-log', '💡 请手动在应用页面控制台运行测试');
                    }
                }, 2000);
                
            } else {
                log('app-log', '❌ 无法打开应用页面');
                log('app-log', '💡 请确保开发服务器正在运行');
            }
        }
        
        async function testDirectAPI() {
            log('api-log', '🌐 测试直接API调用...');
            
            try {
                // 首先获取对话列表
                log('api-log', '📋 获取对话列表...');
                const response = await fetch('http://localhost:3001/api/messages/conversations');
                
                if (response.ok) {
                    const conversations = await response.json();
                    log('api-log', `✅ 找到 ${conversations.length} 个对话`);
                    
                    if (conversations.length > 0) {
                        const firstConv = conversations[0];
                        log('api-log', `🎯 准备删除对话: ${firstConv.title} (${firstConv.id})`);
                        
                        // 模拟用户确认
                        const userConfirmed = confirm(`确定要删除对话 "${firstConv.title}" 吗？`);
                        
                        if (userConfirmed) {
                            log('api-log', '✅ 用户确认删除，执行API调用...');
                            
                            const deleteResponse = await fetch(`http://localhost:3001/api/messages/conversations/${firstConv.id}`, {
                                method: 'DELETE'
                            });
                            
                            if (deleteResponse.ok) {
                                const result = await deleteResponse.json();
                                log('api-log', '✅ 删除成功: ' + JSON.stringify(result));
                            } else {
                                log('api-log', `❌ 删除失败: ${deleteResponse.status}`);
                            }
                        } else {
                            log('api-log', '❌ 用户取消删除');
                        }
                    } else {
                        log('api-log', '❌ 没有对话可以删除');
                    }
                } else {
                    log('api-log', `❌ 获取对话列表失败: ${response.status}`);
                }
                
            } catch (error) {
                log('api-log', `❌ API测试失败: ${error.message}`);
            }
        }
        
        // 页面加载时的初始化
        window.onload = function() {
            log('basic-log', '📄 测试页面已加载');
            log('app-log', '💡 点击按钮开始测试');
            log('api-log', '💡 准备API测试');
        };
    </script>
</body>
</html>