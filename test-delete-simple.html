<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®€å•åˆ é™¤æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #1a1a1a;
            color: white;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background-color: #2a2a2a;
            border-radius: 8px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 10px 15px;
            margin: 5px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .log {
            background-color: #333;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>ç®€å•åˆ é™¤åŠŸèƒ½æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>æµ‹è¯•1: åŸºæœ¬ç¡®è®¤å¯¹è¯æ¡†</h2>
        <button onclick="testBasicConfirm()">æµ‹è¯•confirmå‡½æ•°</button>
        <div id="basic-log" class="log"></div>
    </div>
    
    <div class="test-section">
        <h2>æµ‹è¯•2: æ£€æŸ¥åº”ç”¨é¡µé¢</h2>
        <button onclick="openAppAndTest()">æ‰“å¼€åº”ç”¨å¹¶æµ‹è¯•åˆ é™¤</button>
        <div id="app-log" class="log"></div>
    </div>
    
    <div class="test-section">
        <h2>æµ‹è¯•3: ç›´æ¥APIæµ‹è¯•</h2>
        <button onclick="testDirectAPI()">æµ‹è¯•APIåˆ é™¤</button>
        <div id="api-log" class="log"></div>
    </div>
    
    <script>
        function log(containerId, message) {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            container.innerHTML += `[${timestamp}] ${message}<br>`;
            container.scrollTop = container.scrollHeight;
        }
        
        function testBasicConfirm() {
            log('basic-log', 'ğŸ”” æµ‹è¯•åŸºæœ¬confirmå‡½æ•°...');
            
            try {
                const result = confirm('è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•ç¡®è®¤å¯¹è¯æ¡†ï¼Œè¯·é€‰æ‹©ç¡®å®šæˆ–å–æ¶ˆ');
                log('basic-log', `âœ… confirmè¿”å›å€¼: ${result}`);
                log('basic-log', 'âœ… confirmå‡½æ•°å·¥ä½œæ­£å¸¸');
            } catch (error) {
                log('basic-log', `âŒ confirmå‡½æ•°é”™è¯¯: ${error.message}`);
            }
        }
        
        function openAppAndTest() {
            log('app-log', 'ğŸŒ æ­£åœ¨æ‰“å¼€åº”ç”¨é¡µé¢...');
            
            // æ‰“å¼€åº”ç”¨é¡µé¢
            const appWindow = window.open('http://localhost:5173/', '_blank');
            
            if (appWindow) {
                log('app-log', 'âœ… åº”ç”¨é¡µé¢å·²æ‰“å¼€');
                log('app-log', 'ğŸ’¡ è¯·åœ¨æ–°çª—å£ä¸­æ‰‹åŠ¨æµ‹è¯•åˆ é™¤åŠŸèƒ½');
                
                // ç­‰å¾…é¡µé¢åŠ è½½åæ³¨å…¥æµ‹è¯•è„šæœ¬
                setTimeout(() => {
                    try {
                        // æ³¨å…¥æµ‹è¯•è„šæœ¬åˆ°åº”ç”¨é¡µé¢
                        const testScript = `
                            console.log('=== åˆ é™¤åŠŸèƒ½æµ‹è¯•å¼€å§‹ ===');
                            
                            // ç›‘æ§confirmå‡½æ•°
                            const originalConfirm = window.confirm;
                            window.confirm = function(message) {
                                console.log('ğŸ”” CONFIRMè¢«è°ƒç”¨!');
                                console.log('ğŸ“ æ¶ˆæ¯:', message);
                                const result = originalConfirm.call(this, message);
                                console.log('âœ… ç”¨æˆ·é€‰æ‹©:', result ? 'ç¡®è®¤' : 'å–æ¶ˆ');
                                return result;
                            };
                            
                            // æŸ¥æ‰¾åˆ é™¤æŒ‰é’®
                            const buttons = document.querySelectorAll('button');
                            console.log('ğŸ“Š é¡µé¢ä¸Šçš„æŒ‰é’®æ•°é‡:', buttons.length);
                            
                            let deleteButtons = [];
                            buttons.forEach((btn, i) => {
                                const hasTrash = btn.innerHTML.includes('Trash') || btn.querySelector('svg');
                                if (hasTrash) {
                                    deleteButtons.push({index: i, button: btn});
                                    console.log('ğŸ—‘ï¸ æ‰¾åˆ°åˆ é™¤æŒ‰é’®:', i, btn.outerHTML.substring(0, 100));
                                }
                            });
                            
                            if (deleteButtons.length > 0) {
                                console.log('âœ… æ‰¾åˆ°', deleteButtons.length, 'ä¸ªåˆ é™¤æŒ‰é’®');
                                console.log('ğŸ’¡ è¯·æ‰‹åŠ¨ç‚¹å‡»åˆ é™¤æŒ‰é’®æµ‹è¯•confirmå¯¹è¯æ¡†');
                            } else {
                                console.log('âŒ æ²¡æœ‰æ‰¾åˆ°åˆ é™¤æŒ‰é’®');
                                console.log('ğŸ’¡ å¯èƒ½éœ€è¦å…ˆåˆ›å»ºä¸€äº›å¯¹è¯');
                            }
                            
                            console.log('=== æµ‹è¯•è„šæœ¬æ³¨å…¥å®Œæˆ ===');
                        `;
                        
                        appWindow.eval(testScript);
                        log('app-log', 'âœ… æµ‹è¯•è„šæœ¬å·²æ³¨å…¥åˆ°åº”ç”¨é¡µé¢');
                        log('app-log', 'ğŸ’¡ è¯·æŸ¥çœ‹åº”ç”¨é¡µé¢çš„æ§åˆ¶å°è¾“å‡º');
                        
                    } catch (error) {
                        log('app-log', `âŒ æ³¨å…¥è„šæœ¬å¤±è´¥: ${error.message}`);
                        log('app-log', 'ğŸ’¡ è¯·æ‰‹åŠ¨åœ¨åº”ç”¨é¡µé¢æ§åˆ¶å°è¿è¡Œæµ‹è¯•');
                    }
                }, 2000);
                
            } else {
                log('app-log', 'âŒ æ— æ³•æ‰“å¼€åº”ç”¨é¡µé¢');
                log('app-log', 'ğŸ’¡ è¯·ç¡®ä¿å¼€å‘æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ');
            }
        }
        
        async function testDirectAPI() {
            log('api-log', 'ğŸŒ æµ‹è¯•ç›´æ¥APIè°ƒç”¨...');
            
            try {
                // é¦–å…ˆè·å–å¯¹è¯åˆ—è¡¨
                log('api-log', 'ğŸ“‹ è·å–å¯¹è¯åˆ—è¡¨...');
                const response = await fetch('http://localhost:3001/api/messages/conversations');
                
                if (response.ok) {
                    const conversations = await response.json();
                    log('api-log', `âœ… æ‰¾åˆ° ${conversations.length} ä¸ªå¯¹è¯`);
                    
                    if (conversations.length > 0) {
                        const firstConv = conversations[0];
                        log('api-log', `ğŸ¯ å‡†å¤‡åˆ é™¤å¯¹è¯: ${firstConv.title} (${firstConv.id})`);
                        
                        // æ¨¡æ‹Ÿç”¨æˆ·ç¡®è®¤
                        const userConfirmed = confirm(`ç¡®å®šè¦åˆ é™¤å¯¹è¯ "${firstConv.title}" å—ï¼Ÿ`);
                        
                        if (userConfirmed) {
                            log('api-log', 'âœ… ç”¨æˆ·ç¡®è®¤åˆ é™¤ï¼Œæ‰§è¡ŒAPIè°ƒç”¨...');
                            
                            const deleteResponse = await fetch(`http://localhost:3001/api/messages/conversations/${firstConv.id}`, {
                                method: 'DELETE'
                            });
                            
                            if (deleteResponse.ok) {
                                const result = await deleteResponse.json();
                                log('api-log', 'âœ… åˆ é™¤æˆåŠŸ: ' + JSON.stringify(result));
                            } else {
                                log('api-log', `âŒ åˆ é™¤å¤±è´¥: ${deleteResponse.status}`);
                            }
                        } else {
                            log('api-log', 'âŒ ç”¨æˆ·å–æ¶ˆåˆ é™¤');
                        }
                    } else {
                        log('api-log', 'âŒ æ²¡æœ‰å¯¹è¯å¯ä»¥åˆ é™¤');
                    }
                } else {
                    log('api-log', `âŒ è·å–å¯¹è¯åˆ—è¡¨å¤±è´¥: ${response.status}`);
                }
                
            } catch (error) {
                log('api-log', `âŒ APIæµ‹è¯•å¤±è´¥: ${error.message}`);
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.onload = function() {
            log('basic-log', 'ğŸ“„ æµ‹è¯•é¡µé¢å·²åŠ è½½');
            log('app-log', 'ğŸ’¡ ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•');
            log('api-log', 'ğŸ’¡ å‡†å¤‡APIæµ‹è¯•');
        };
    </script>
</body>
</html>